<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>DASHBOARD GERAL</title>
   <link rel="stylesheet" href="style.css">
</head>

<body>
   <div class="navbarDashboard">

      <div class="logoDashboard ">
         <img src="img/imgLogo.png" alt="" width="55px" height="55px">
      </div>
      <div class="NavbarTextDashboard">
         <a href="#">Gerenciar Funcionário</a>
         <a href="#">Gerenciar Empresa</a>
         <a href="#">Gerenciar Empresa</a>

      </div>
      <div class="imgUser">
         <img src="img/imgUser.png" alt="" width="100%" height="100%">
      </div>
   </div>
   <div class="bodyDashboard">
      <div class="leftDash">
         <div class="textCompany">
            <h2>Itaú Unibanco - 29 De Julho / E2709</h2>
         </div>
         <div class="generalQuality">
            <h4>Qualidade Geral do Prédio</h4>
         </div>
         <div class="cardIndex">
            <section style="width: 100%;">
               <canvas id="luminosidade"></canvas>
            </section>
         </div>
         <div class="horizontalLine"></div>
         <div class="Generalmonitoring">
            <h4>Monitoramento Geral</h4>
         </div>
         <div class="sensors">
            <div class="sensor1">sadasdsa</div>
            <div class="sensor2">sadasdas</div>
         </div>
      </div>

      <div class="rightDash">
         <div class="textAbsenteeism">
            <h2>Taxa de Absenteísmo Geral</h2>
         </div>
         <div class="absenteeismGraph">
            <section style="width: 40%;">
               <canvas id="lm35Temperatura"></canvas>
            </section>
         </div>
         <div class="overallPercentage">
            <div class="Percentage1">50%</div>
            <div class="Percentage2">50%</div>
         </div>
         <div class="textEnvironments">
            <h3>Ambientes</h3>
         </div>

         <div class="environments">
            <div class="environments1">sdvsd</div>
            <div class="environments2">svdsvdsv</div>
         </div>


      </div>
   </div>


   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>

</html>


<script>

   var contextoLuminosidade = document.getElementById('luminosidade').getContext('2d');
   contextoLuminosidade.canvas.width = 1000;
   contextoLuminosidade.canvas.height = 300;
   var luminosidade = new Chart(
      contextoLuminosidade,
      {
         type: 'line',
         data: {
            datasets: [{
               label: 'Luminosidade',
               type: 'line',
               borderColor: ['#ffd902'],
               backgroundColor: ['rgba(255, 217, 2, 0.0)']
            }]
         },
         options: {
            scales: {
               xAxes: [{
                  distribution: 'series',
                  ticks: {
                     beginAtZero: true,
                     index: 5
                  }
               }],
               yAxes: [{
                  scaleLabel: {
                     display: true,
                     labelString: 'Luminosidade'
                  },
                  ticks: {
                     beginAtZero: true
                  }
               }]
            },
            animation: {
               duration: 1
            }
         }
      }
   );

   var contextoLm35Temperatura = document.getElementById('lm35Temperatura').getContext('2d');
   contextoLm35Temperatura.canvas.width = 300;
   contextoLm35Temperatura.canvas.height = 300;

   const data = [50, 50];
   var lm35Temperatura = new Chart(
      contextoLm35Temperatura,
      {
         type: 'doughnut',
         data: {
            labels: [
               'Faltas',
               'Presença'
            ],
            datasets: [{
               label: 'Temperatura',
               data: data,
               backgroundColor: [
                  'rgb(255, 99, 132)',
                  'rgb(54, 162, 235)',
                  'rgb(255, 205, 86)'
               ],
               hoverOffset: 4
            }]
         },
         options: {
            scales: {
               xAxes: [{
                  distribution: 'series',
                  ticks: {
                     beginAtZero: true
                  }
               }],
               yAxes: [{
                  scaleLabel: {
                     display: true,
                     labelString: 'Temperatura'
                  },
                  ticks: {
                     beginAtZero: true
                  }
               }]
            },
            animation: {
               duration: 0
            }
         }
      }
   );

   /* Código Original
   var lm35Temperatura = new Chart(
      contextoLm35Temperatura,
      {
         type: 'line',
         data: {
            datasets: [{
               label: 'Temperatura',
               type: 'line',
               borderColor: ['#ffd902'],
               backgroundColor: ['#ffe135']
            }]
         },
         options: {
            scales: {
               xAxes: [{
                  distribution: 'series',
                  ticks: {
                     beginAtZero: true
                  }
               }],
               yAxes: [{
                  scaleLabel: {
                     display: true,
                     labelString: 'Temperatura'
                  },
                  ticks: {
                     beginAtZero: true
                  }
               }]
            },
            animation: {
               duration: 0
            }
         }
      }
   );
*/


   var paginacao = {};
   var tempo = {};
   function obterDados(grafico, endpoint) {
      var http = new XMLHttpRequest();
      http.open('GET', 'http://localhost:3300/sensores/' + endpoint, false);
      http.send(null);
      var valores = JSON.parse(http.responseText);
      if (paginacao[endpoint] == null) {
         paginacao[endpoint] = 0;
      }
      if (tempo[endpoint] == null) {
         tempo[endpoint] = 0;
      }
      // Exibir à partir do último elemento exibido anteriormente
      var ultimaPaginacao = paginacao[endpoint];
      paginacao[endpoint] = valores.length;
      var valores = valores.slice(ultimaPaginacao);
      valores.forEach((valor) => {
         //Máximo de 60 itens exibidos no gráfico
         if (grafico.data.labels.length == 10 && grafico.data.datasets[0].data.length == 10) {
            grafico.data.labels.shift();
            grafico.data.datasets[0].data.shift();
         }

         grafico.data.labels.push(tempo[endpoint]++);
         grafico.data.datasets[0].data.push(parseFloat(valor));
         grafico.update();
      })
   }


   function obterDados2(grafico, endpoint) {
      var http = new XMLHttpRequest();
      http.open('GET', 'http://localhost:3300/sensores/' + endpoint, false);
      http.send(null);
      var valores = JSON.parse(http.responseText);
      if (paginacao[endpoint] == null) {
         paginacao[endpoint] = 0;
      }
      var todosOsValores = JSON.parse(http.responseText);


      if (tempo[endpoint] == null) {
         tempo[endpoint] = 0;
      }
      // Exibir à partir do último elemento exibido anteriormente
      var ultimaPaginacao = paginacao[endpoint];
      paginacao[endpoint] = valores.length;
      var valores = valores.slice(ultimaPaginacao);

      //Máximo de 60 itens exibidos no gráfico
      tamArr = todosOsValores.length

      console.log("é nan? " + isNaN(grafico.data.datasets[0].data[0] = todosOsValores[tamArr - 2]));


      if (!isNaN(grafico.data.datasets[0].data[0] = todosOsValores[tamArr - 2])) {
         grafico.data.datasets[0].data[0] = todosOsValores[tamArr - 2];
      }
      if (!isNaN(grafico.data.datasets[0].data[1] = todosOsValores[(tamArr) - 1])) {
         grafico.data.datasets[0].data[1] = (todosOsValores[tamArr - 1]);
      }
      console.log((parseFloat(todosOsValores[(tamArr) - 1])));
      console.log((parseFloat(todosOsValores[(tamArr) - 2])));
      grafico.update();
      valores.shift();

   }


   setInterval(() => {

      obterDados(luminosidade, 'luminosidade');
      obterDados2(lm35Temperatura, 'lm35/temperatura');

   }, 2000);



</script>