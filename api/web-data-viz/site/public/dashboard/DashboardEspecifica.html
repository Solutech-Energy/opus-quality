<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="shortcut icon" href="..img/logoFavicon.ico" type="image/x-icon">
    <title>Opus | Dashboard Específica</title>
</head>

<body>



    <span id="containerAlertas" class="cardAlertaGeral">


    </span>








    <div id="pop-up">
        <div class="sectionGraficosGeral">
            <div class="titleSection">
                <h2>Gráficos Quadrante <span id="nomeQuadrante">Quadrante #</span></h2>
                <svg xmlns="http://www.w3.org/2000/svg" onclick="fecharPopUp()" width="25" height="25" fill="black"
                    class="bi bi-x-lg" viewBox="0 0 16 16">
                    <path
                        d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z" />
                </svg>
            </div>
            <div class="titlesCards">
                <span>Temperatura</span>
                <span>Luminosidade</span>
            </div>
            <div class="cardGraficos">
                <div class="cardGraficoDados">
                    <canvas id="graficoLM35"></canvas>
                </div>
                <div class="cardGraficoDados">
                    <canvas id="graficoLDR5"></canvas>
                </div>
            </div>

        </div>
    </div>


    <div class="containerGeralDashEspecifica">

        <div class="DashEspecificaLeft">
            <div class="navbarDash">

                <div id="resultado">
                </div>

                <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" fill="currentColor"
                    class="bi bi-person-circle" viewBox="0 0 16 16">
                    <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z" />
                    <path fill-rule="evenodd"
                        d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z" />
                </svg>

                <div class="nomeUsuario">Olá, <span>Luiz</span></div>
                <div class="buttonLateral">
                    <span><a href="dashGeral.html">Dashboard Geral</a></span>
                </div>

                <div class="buttonSair">
                    <span>Sair</span>
                </div>
            </div>
            <div style="width: 100%; height: 100%; background-color: aquamarine; display: none; position: absolute;">

            </div>
            <div class="faixaAlertas">

                <h2>Temperatura</h2>

                <div class="cardsEspecifica">

                    <div class="titleAlert">
                        <span>Alertas (Cº) </span>
                    </div>
                    <div class="AlertLeft">
                        <div class="Cores">
                            <div class="alerta">
                                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="purple"
                                    class="bi bi-circle-fill" viewBox="0 0 16 16">
                                    <circle cx="8" cy="8" r="8" />
                                </svg>
                                <span>
                                    < 20º</span>

                            </div>
                            <div class="alerta">
                                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="blue"
                                    class="bi bi-circle-fill" viewBox="0 0 16 16">
                                    <circle cx="8" cy="8" r="8" />
                                </svg>
                                <span>20.5º - 22º</span>
                            </div>
                            <div class="alerta">
                                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="green"
                                    class="bi bi-circle-fill" viewBox="0 0 16 16">
                                    <circle cx="8" cy="8" r="8" />
                                </svg>
                                <span>22º - 24º</span>

                            </div>
                            <div class="alerta">
                                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="yellow"
                                    class="bi bi-circle-fill" viewBox="0 0 16 16">
                                    <circle cx="8" cy="8" r="8" />
                                </svg>
                                <span>24.5º - 26º</span>

                            </div>
                            <div class="alerta">
                                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="red"
                                    class="bi bi-circle-fill" viewBox="0 0 16 16">
                                    <circle cx="8" cy="8" r="8" />
                                </svg>
                                <span> > 27</span>
                            </div>
                        </div>
                    </div>
                </div>


                <h2>Luminosidade</h2>

                <div class="cardsEspecifica">
                    <div class="titleAlert">
                        <span>Alertas (Luz) </span>
                    </div>
                    <div class="AlertLeft">
                        <div class="Cores">
                            <div class="alerta">
                                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="purple"
                                    class="bi bi-circle-fill" viewBox="0 0 16 16">
                                    <circle cx="8" cy="8" r="8" />
                                </svg>
                                <span>
                                    < 500</span>
                            </div>
                            <div class="alerta">
                                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="blue"
                                    class="bi bi-circle-fill" viewBox="0 0 16 16">
                                    <circle cx="8" cy="8" r="8" />
                                </svg>
                                <span>500 - 530</span>
                            </div>
                            <div class="alerta">
                                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="green"
                                    class="bi bi-circle-fill" viewBox="0 0 16 16">
                                    <circle cx="8" cy="8" r="8" />
                                </svg>
                                <span>531 - 987</span>
                            </div>
                            <div class="alerta">
                                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="yellow"
                                    class="bi bi-circle-fill" viewBox="0 0 16 16">
                                    <circle cx="8" cy="8" r="8" />
                                </svg>
                                <span>988 - 1000</span>
                            </div>
                            <div class="alerta">
                                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="red"
                                    class="bi bi-circle-fill" viewBox="0 0 16 16">
                                    <circle cx="8" cy="8" r="8" />
                                </svg>
                                <span> > 1000</span>
                            </div>
                        </div>
                    </div>
                </div>


            </div>

        </div>

        <div class="DashEspecificaRight">

            <h1 id="apelidoSetor" style="color:white; margin: 0 auto; position: absolute;">Carregando</h1>
            <div class="plantaDashEspecifica">
                <div class="Quadrantes123">

                    <div class="QuadrantesBom" id="quadranteA1" onclick="aparecerPopUp(0)"> 26,6º<br>177</div>
                    <div class="QuadrantesBom" id="quadranteA2" onclick="aparecerPopUp(1)"></div>
                    <div class="QuadrantesBom" id="quadranteA3" onclick="aparecerPopUp(2)"></div>

                </div>

                <div class="Quadrantes456">
                    <div class="QuadrantesBom" id="quadranteA4" onclick="aparecerPopUp(3)"></div>
                    <div class="QuadrantesBom" id="quadranteA5" onclick="aparecerPopUp(4)"></div>
                    <div class="QuadrantesBom" id="quadranteA6" onclick="aparecerPopUp(5)"></div>


                </div>
            </div>




        </div>



    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>



</body>

</html>

<script>
    if (sessionStorage.idSetor == undefined) {
        window.location.href = "/dashboard";
    }


    var valoresTemperatura = {
        A1: [],
        A2: [],
        A3: [],
        A4: [],
        A5: [],
        A6: []
    }
    var valoresLuminosidade = {
        A1: [],
        A2: [],
        A3: [],
        A4: [],
        A5: [],
        A6: []
    };
    var quadranteAtual = 'A1';
    var setor;
    function atualizarGrafico(quadrante) {
        fetch(`/medidas/dadosSetor/${sessionStorage.idSetor}`)
            .then(response => response.json())
            .then(data => {
                //  console.log(data);
                setor = data;
                document.getElementById('apelidoSetor').innerHTML = data[0].apelido;
                buscarQuadrante(data[0].idSetor, quadrante);
            })
            .catch(error => console.log(error));
    }

    containerAlertas.style.display = "none"

    setInterval(() => {
        atualizarGrafico("A1");
        atualizarGrafico("A2");
        atualizarGrafico("A3");
        atualizarGrafico("A4");
        atualizarGrafico("A5");
        atualizarGrafico("A6");

    }, 1000);

    function buscarQuadrante(setor, quadrante) {
        fetch('/medidas/dadosQuadrante/' + setor + '/' + quadrante)
            .then(response => response.json())
            .then(data => {
                //  console.log(data);
                quadrantes = data;
                valoresTemperatura[quadrante] = [];
                valoresLuminosidade[quadrante] = [];
                for (let i = 0; i < data.length; i++) {
                    if (data[i].tipo != "luminosidade") {
                        valoresLuminosidade[quadrante].push(data[i].valor);
                    } else {
                        valoresTemperatura[quadrante].push(data[i].valor);
                    }
                }
                //      console.log(valoresLuminosidade), "Valores Luminosidade";
                //   console.log(valoresTemperatura), "Valores Temperatura";

                validarLimites(valoresLuminosidade[quadrante], valoresTemperatura[quadrante]);

                graficoLuminosidade.data.datasets[0].data = valoresLuminosidade[quadrante];
                graficoTemperatura.data.datasets[0].data = valoresTemperatura[quadrante];
                graficoLuminosidade.update();
                graficoTemperatura.update();
                quadranteA1.innerHTML = `${valoresTemperatura.A1[0]}º <br>${valoresLuminosidade.A1[0]} Lux`;
                quadranteA2.innerHTML = `${valoresTemperatura.A2[1]}º <br>${valoresLuminosidade.A2[1]} Lux`;
                quadranteA3.innerHTML = `${valoresTemperatura.A3[2]}º <br>${valoresLuminosidade.A3[2]} Lux`;
                quadranteA4.innerHTML = `${valoresTemperatura.A4[3]}º <br>${valoresLuminosidade.A4[3]} Lux`;
                quadranteA5.innerHTML = `${valoresTemperatura.A5[4]}º <br>${valoresLuminosidade.A5[4]} Lux`;
                quadranteA6.innerHTML = `${valoresTemperatura.A6[5]}º <br>${valoresLuminosidade.A6[5]} Lux`;

            })
            .catch(error => console.log(error));
    }


    function aparecerPopUp(id) {
        quadranteAtual = 'A' + (id + 1);
        console.log("quadranteAtual: ", quadranteAtual);
        // console.log("quadrantes: ", quadrantes);
        nomeQuadrante.innerHTML = quadranteAtual;
        var popUp = document.getElementById(`pop-up`);
        popUp.style.display = "flex"
    }


    function fecharPopUp() {
        var popUp = document.getElementById(`pop-up`);
        popUp.style.display = "none"
    }
    const ctx = document.getElementById('graficoLDR5');

    const graficoLuminosidade = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['10:00', '10:30', '11:00', '11:30', '12:00', '12:30'],
            datasets: [{
                label: 'Luminosidade (Lux)',
                data: [12, 19, 3, 5, 2, 3],
                borderWidth: 3,
                borderColor: '#EF8A14',
                backgroundColor: '#EF8A14',
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    const ctx2 = document.getElementById('graficoLM35');

    const graficoTemperatura = new Chart(ctx2, {
        type: 'line',
        data: {
            labels: ['10:00', '10:30', '11:00', '11:30', '12:00', '12:30'],
            datasets: [
                {
                    label: 'Temperatura',
                    data: [12, 19, 3, 5, 2, 3],
                    borderWidth: 3,

                }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });


    alertas = []


    function exibirAlertas(array) {
        console.log("Entramos na funcao exibirAlertas, este é o array: ", array);
        var containerAlertas = document.getElementById("containerAlertas");
        //  alert =(!array)
        if (array == []) {
            containerAlertas.style.display = 'none'
            return false;
        } else {
            containerAlertas.style.display = 'block'
        }

        containerAlertas.innerHTML = "";
        for (var i = 0; i < array.length; i++) {
            var item = array[i];
            var medida = "";
            if (item.nome == "temperatura") {
                medida = "ºC"
            } else if (item.nome == "luminosidade") {
                medida = "Lux"
            }
            containerAlertas.innerHTML += `
                 <div class="AlertaCard" style="margin-top: ${i * 22}vh">
        <div class="iconeAlert">
            <svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" fill="${item.cor}"
                class="bi bi-exclamation-triangle-fill" viewBox="0 0 16 16">
                <path
                    d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z" />
            </svg>

        </div>

        <div class="sectionTexto">


            <div class="titleAlert">

                <h4>${item.nome}</h4>
            </div>

            <div class="textoAlerta">
                <span id="">O <span style="color: red;">${item.setor}</span> está com ${item.valor} ${medida} no <span
                        style="color: red;">${item.quadrante}</span></span>
            </div>
        </div>
    </div>
                `

        }
        console.log("Alertas: ", alertas);
    }


    exibirAlertas(alertas)
    function validarLimites(luz, temp) {
        //console.log("antigo: ", alertas);
        // console.log("Entramos na validacao, este é  setor: ", setor);
        alertas = []
        var cor;
        for (var i = 0; i < luz.length; i++) {
            if (luz[i] < setor[0].minLuminosidade || luz[i] > setor[0].maxLuminosidade) {
                if (luz[i] < 500) {
                    cor = 'purple';
                } else if (luz[i] < 530) {
                    cor = 'blue';
                } else if (luz[i] < 987) {
                    cor = 'green';
                } else if (luz[i] < 1000) {
                    cor = 'yellow';
                } else if (luz[i] > 1000) {
                    cor = 'red';
                }
                alertas.push({
                    nome: "Luminosidade",
                    setor: setor[0].apelido,
                    quadrante: "Quadrante " + (i + 1),
                    valor: luz[i],
                    cor: cor
                })
            }
        }
        for (var i = 0; i < temp.length; i++) {
            // console.log("Entramos no for, os minimos são ", setor[0].minTemperatura, " e os maximos são ", setor[0].maxTemperatura);
            if (temp[i] > Number(setor[0].maxTemperatura) || temp[i] < Number(setor[0].minTemperatura)) {
                if (temp[i] < 20.5) {
                    cor = 'purple'
                } else if (temp[i] < 22) {
                    cor = 'blue'
                } else if (temp[i] < 24.5) {
                    cor = 'green'
                } else if (temp[i] < 27) {
                    cor = 'yellow'
                } else if (temp[i] > 27) {
                    cor = 'red'
                }



                alertas.push({
                    nome: "Temperatura",
                    setor: setor[0].apelido,
                    quadrante: "Quadrante " + (i + 1),
                    valor: temp[i],
                    cor: cor
                })
            }
        }
        // console.log("novo: ", alertas);
        exibirAlertas(alertas);
    }


</script>